---
title: "Untitled"
output: html_document
---

```{r}
rm(list=ls())
library(dplyr)
library(readr)
library("rstan") # observe startup messages
rstan_options(auto_write = TRUE)
options(mc.cores = parallel::detectCores())
```

```{r}
J <- 5
N <- 5000
pois_data <- matrix(0, nrow = J, ncol = N)
pois_data[1,] <- rpois(N, 0.04)
pois_data[2,] <- rpois(N, 0.08)
pois_data[3,] <- rpois(N, 0.16)
pois_data[4,] <- rpois(N, 0.32)
pois_data[5,] <- rpois(N, 0.64)

exp_var <- c(2,1,0,-1,-2)
```

```{r}
pois_dat <- list(J = J,
                 N = N,
                 y = pois_data,
                 gamma_scale = 0.1,
                 exp_var <- exp_var)
fit <- stan(file = 'poisson-gamma.stan', data = pois_dat, 
            iter = 1000, chains = 4)

```

```{r}
print(fit, digits = 2)
```

```{r}
plot(fit, pars=c("beta[1]", "beta[2]"))
```


```{r}
pairs(fit, pars = c("beta"))
```
```{r}
list_of_draws <- extract(fit)
print(names(list_of_draws))
```

```{r}
mean(list_of_draws$beta[,2])
```

```{r}
pc <- read_csv('../precrime_data/pivoted_felonies.csv')
pc$DAY_HOUR = as.factor(paste(pc$COMPLAINT_DAYOFWEEK, pc$COMPLAINT_HOURGROUP, sep='_'))
pc$ADDR_PCT_CD = as.factor(pc$ADDR_PCT_CD)
```

```{r}
  # int<lower=1> N;                                 // number of observations
  # int<lower=1> num_precincts;                     // number of precincts
  # int<lower=1,upper=num_precincts> precinct[N];   // precinct for each observation
  # int<lower=1,upper=42> hourgroup[N];             // hourgroup for each observation
  # 
  # real<lower=0> gamma_scale;                      // affects the prior
  # 
  # int<lower=0> y[N];                              // data

precrime_data <- list(
  N = nrow(pc),
  num_precincts = nlevels(pc$ADDR_PCT_CD),
  precinct = as.integer(pc$ADDR_PCT_CD),
  hourgroup = as.integer(pc$DAY_HOUR),
  gamma_scale = 0.1,
  y <- pc$GrandLarceny
)
fit <- stan(file = 'precrime.stan', data = precrime_data, 
            iter = 1000, chains = 4)

```

```{r}
nrow(pc)
nlevels(pc$ADDR_PCT_CD)
```

